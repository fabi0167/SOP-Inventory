<app-navbar></app-navbar>

<div class="container mt-4">
  <h2>Inventar</h2>

  <!-- This div is for all the content on the page. -->
  <div class="container mt-5">
    <div class="row">
      <div class="col-md-2">
        <div class="card">
          <!-- This part is for the filter area of the page. -->
          <div class="card-body">
            <h5 class="card-title">Filtre</h5>
            <div>
              <button id="refreshBtn" class="btn btn-primary" style="box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2)"
                (click)="refreshFilter()">
                Genindlæs
              </button>
            </div>
            <div class="grid-items" *ngFor="let itemType of itemTypes">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" [value]="itemType.id"
                  [checked]="selectedItemTypes[itemType.id] || false" (change)="onChecked(itemType.id, $event)" />
                <label class="mb-4">{{ itemType.typeName }}</label>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-8">
        <div class="card">
          <!-- This part is for the add item button and for the 1st searchbar. -->
          <div class="inventartitle">
            <button type="button" class="btn btn-success m-2" style="box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2)"
              (click)="openNewItemModal()">
              Ny Genstand
            </button>
          </div>
          <div class="form-group m-2">
            <h1 for="searchRoom" style="text-align: center">Søg Grupper:</h1>
            <input type="text" class="form-control" id="searchRoom" [(ngModel)]="searchItemGroup"
              (input)="updateDisplayedItems()" placeholder="Søg Grupper" />
          </div>

          <!-- This part is for the item groups. -->
          <div class="card-body-items">
            <div class="grid-container">
              <div class="grid-item" *ngFor="let selectedItemGroup of selectedItemGroups">
                <div id="textSize" class="model-name" (click)="onItemGroupClick(selectedItemGroup, $event)">
                  {{ selectedItemGroup.modelName }}
                </div>
              </div>
            </div>
          </div>

          <!-- This part is for the items in the item groups. -->
          <div id="item-list" *ngIf="isVisible">
            <div class="d-flex">
              <button class="btn btn-primary ml-2" (click)="IsVisible()">
                Gå Tilbage
              </button>
              <button class="btn ms-auto mr-2" [ngClass]="showInfoModal ? 'btn-danger' : 'btn-primary'"
                (click)="showInformation()">
                {{ showInfoModal ? 'Skjul Information' : 'Vis Information' }}

              </button>

            </div>

            <h4><b>Genstand:</b></h4>
            <div class="form-group m-2">
              <h1 for="searchRoom" style="text-align: center"></h1>
              <input type="text" class="form-control" id="searchRoom" [(ngModel)]="searchItem" (input)="onItemSearch()"
                placeholder="Søg Genstand" />
            </div>
            <div class="table-responsive">
              <table class="text-dark">
                <thead>
                  <tr>
                    <th>Billede</th>
                    <th>Serienummer</th>
                    <th>Genstandsgruppe</th>
                    <th>Adresse</th>
                    <th>Bygning</th>
                    <th>Lokale</th>
                    <th *ngIf="currentUser?.role?.id === 1 || currentUser?.role?.id === 4">Arkiver</th>
                    <th>Rediger</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let item of filteredItems" (click)="onLineClick(item, $event)">
                    <td>
                      <ng-container *ngIf="item.itemImageUrl; else noImage">
                        <img [src]="item.itemImageUrl" alt="Billede af genstand" class="item-image" />
                      </ng-container>
                      <ng-template #noImage>
                        <span class="no-image-text">Intet billede fundet</span>
                      </ng-template>
                    </td>
                    <td (click)="onLineClick(item, $event)">
                      {{ item.serialNumber }}
                    </td>
                    <td (click)="onLineClick(item, $event)">
                      {{ item.itemGroup?.modelName }}
                    </td>
                    <td (click)="onLineClick(item, $event)">
                      {{ getAddressInfo(item.roomId) }}
                    </td>
                    <td (click)="onLineClick(item, $event)">
                      {{ getBuildingInfo(item.roomId) }}
                    </td>
                    <td (click)="onLineClick(item, $event)">
                      {{ getRoomNumber(item.roomId) }}
                    </td>
                    <td *ngIf="currentUser?.role?.id === 1 || currentUser?.role?.id === 4">
                      <!--the span ? if true and : if false-->
                      <span [title]="isDeleteDisabled(item.id) ? 'Denne genstand er lånt ud' : ''">
                        <button type="button" class="btn btn-danger" [disabled]="isDeleteDisabled(item.id)"
                          (click)="openArchiveModal(item); $event.stopPropagation()">
                          Arkiver
                        </button>
                      </span>

                    </td>
                    <td>
                      <button class="btn btn-primary btn-sm" (click)="
                          openEditItemModal(item); $event.stopPropagation()
                        ">
                        Rediger
                      </button>
                    </td>
                  </tr>

                  <tr *ngIf="filteredItems.length === 0">
                    <td colspan="7" class="text-center text-muted">
                      Ingen genstande fundet.
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-2">
        <div class="card shadow-sm border-0" *ngIf="isVisible && showInfoModal">
          <div class="card-header bg-primary text-white text-center">
            <h5 class="mb-0">{{ selectedItemGroup.modelName }}</h5>
          </div>
          <div class="card-body">
            <ul class="list-group list-group-flush">
              <li class="list-group-item d-flex justify-content-between">
                <strong>ID:</strong> <span>{{ selectedItemGroup.id }}</span>
              </li>
              <li class="list-group-item d-flex justify-content-between">
                <strong>Type:</strong> <span>{{ selectedItemGroup.itemType?.typeName }}</span>
              </li>
              <li class="list-group-item d-flex justify-content-between">
                <strong>Producent:</strong> <span>{{ selectedItemGroup.manufacturer }}</span>
              </li>
              <li class="list-group-item d-flex justify-content-between">
                <strong>Antal:</strong> <span>{{ selectedItemGroup.quantity }}</span>
              </li>
              <li class="list-group-item d-flex justify-content-between">
                <strong>Pris:</strong> <span>{{ selectedItemGroup.price | currency:'DKK':'symbol' }}</span>
              </li>
              <li class="list-group-item d-flex justify-content-between">
                <strong>Garanti:</strong> <span>{{ selectedItemGroup.warrantyPeriod }}</span>
              </li>
            </ul>
          </div>

        </div>

        <!-- Placeholder when no group is selected -->
        <div class="card shadow-sm border-0 text-center" *ngIf="!selectedItemGroup">
          <div class="card-body text-muted">
            <p>Vælg en gruppe for at se detaljer</p>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Edit Item Modal -->
<div class="modal" *ngIf="showEditModal">
  <div class="modal-content">
    <span class="close" (click)="closeEditItemModal()">&times;</span>
    <h2>Rediger Genstand</h2>
    <form (ngSubmit)="editItem()">
      <div class="form-group">
        <label for="editItemGroupId">Gendstandsgruppe</label>
        <select class="form-control" id="editItemGroupId" [(ngModel)]="selectedItem.itemGroupId" name="editItemGroupId"
          required>
          <option *ngFor="let itemGroup of itemGroups" [value]="itemGroup.id">
            {{ itemGroup.modelName }}
          </option>
        </select>
      </div>
      <div class="form-group">
        <label for="editRoomId">Lokale</label>
        <select class="form-control" id="editRoomId" [(ngModel)]="selectedItem.roomId" name="editRoomId" required>
          <option *ngFor="let room of rooms" [value]="room.id">
            {{ room.roomNumber }} ,
            {{ room.building?.buildingAddress?.road || "No Road Info" }}
          </option>
        </select>
      </div>
      <div class="form-group">
        <label for="editSerialNumber">Serienummer</label>
        <input type="text" class="form-control" id="editSerialNumber" [(ngModel)]="selectedItem.serialNumber"
          name="editSerialNumber" />
      </div>

      <div class="form-group">
        <label for="userImage">Brugerbillede:</label>
        <input type="file" class="form-control" id="userImage" accept="image/*" (change)="onImageSelected($event)"
          [disabled]="isUploadingImage" />

        <!-- Preview selected image -->
        <div *ngIf="selectedImagePreview" class="mt-2">
          <label>Forhåndsvisning: </label>
          <img [src]="selectedImagePreview" class="img-thumbnail fixed-preview ml-2" style="max-height: 150px;" />

          <!-- Reset/Delete Image Button -->
          <div class="mt-2 mb-4">
            <button type="button" class="btn btn-sm btn-warning" (click)="resetImage()">
              Fjern billede
            </button>
          </div>
        </div>
      </div>

      <button type="submit" class="btn btn-primary">Gem</button>
      <button type="button" class="btn btn-secondary" (click)="closeEditItemModal()">
        Cancel
      </button>
    </form>
  </div>
</div>

<!--MODEL FOR ARCHIVE ITEM-->
<div class="modal" *ngIf="showArchiveModal">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Arkiver Genstand</h5>
        <button type="button" class="close" aria-label="Close" (click)="closeArchiveModal()">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="ar">Skriv note:</label>
          <input type="text" class="form-control" id="archiveNote" name="archiveNote" [(ngModel)]="archiveNote"
            placeholder="Skriv note om hvorfor" />

          <div class="text-danger" *ngIf="showErrorNote">Note er påkrævet.</div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeArchiveModal()">
          Annuller
        </button>
        <button type="button" class="btn btn-danger" (click)="confirmArchiveItem()">
          Arkiver
        </button>
      </div>
    </div>
  </div>
</div>





<!-- New Genstandboks -->
<div class="nyGenstandBoks" *ngIf="showModal">
  <div class="nyGenstandboks-content">
    <span class="close" (click)="closeNewItemModal()">&times;</span>
    <h2>Ny Genstand</h2>
    <form (ngSubmit)="createNewItem()">
      <div class="form-group">
        <label for="roomId">Lokale</label>
        <select class="form-control" id="user" [(ngModel)]="newItem.roomId" name="user" required>
          <option *ngFor="let room of rooms" [value]="room.id">
            {{ room.roomNumber }} ,
            {{ room.building?.buildingAddress?.road || "No Road Info" }}
          </option>
        </select>
      </div>

      <div class="form-group">
        <label for="itemGroupId">Genstandsgruppe</label>
        <select class="form-control" id="itemGroupId" [(ngModel)]="newItem.itemGroupId" name="itemGroupId" required
          (change)="onItemGroupChange()">
          <option *ngFor="let itemGroup of itemGroups" [value]="itemGroup.id">
            {{ itemGroup.modelName }}
          </option>
        </select>
      </div>

      <div class="form-group">
        <label for="serialNumber">Serienummer</label>
        <input type="text" class="form-control" id="serialNumber" [(ngModel)]="newItem.serialNumber"
          name="serialNumber" />
      </div>


      <!--Item Details-->
      <div *ngIf="selectedPresetData" class="preset-fields-container mt-3">
        <h5>Genstand Detaljer:</h5>

        <div class="details-grid">
          <div *ngFor="let key of objectKeys(selectedPresetData)" class="form-group">
            <div class="label-with-checkbox">
              <label [for]="'skip-' + key">{{ key }}</label>
              <input type="checkbox" [id]="'skip-' + key" [(ngModel)]="enabledFields[key]" (change)="toggleField(key)"
                [name]="'skip-' + key" />
            </div>

            <input [type]="getInputType(selectedPresetData[key])" class="form-control" [id]="key"
              [(ngModel)]="itemInfoObj[key]" [name]="key" [disabled]="!enabledFields[key]" />
          </div>

        </div>
      </div>


      <div class="form-group">
        <label for="itemImage">Genstandbillede:</label>
        <input type="file" class="form-control" id="userImage" accept="image/*" (change)="onImageSelected($event)"
          [disabled]="isUploadingImage" />

        <!-- Preview selected image -->
        <div *ngIf="selectedImagePreview" class="mt-2">
          <label>Forhåndsvisning: </label>
          <img [src]="selectedImagePreview" class="img-thumbnail fixed-preview ml-2" style="max-height: 150px;" />

          <!-- Reset/Delete Image Button -->
          <div class="mt-2 mb-4">
            <button type="button" class="btn btn-sm btn-warning" (click)="resetImage()">
              Fjern billede
            </button>
          </div>
        </div>
      </div>

      <button type="submit" class="btn btn-success">Opret</button>
      <button type="button" class="btn btn-secondary" (click)="closeNewItemModal()">
        Cancel
      </button>
    </form>
  </div>
</div>